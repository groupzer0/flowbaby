# Architectural Findings – Plan 016.1: Fix Tool Lifecycle and Bridge Timeouts

**Date**: 2025-11-19 18:10
**Architect**: GitHub Copilot (GPT-5.1-Codex Preview)
**Reviewed Artifacts**:

- `agent-output/planning/016.1-fix-tool-lifecycle-and-timeouts.md`
- `agent-output/qa/016-agent-retrieval-and-ui-visible-extension-tools-qa.md`
- `agent-output/architecture/system-architecture.md`

**Verdict**: **APPROVED_WITH_NOTES** – Scope is focused, but implementation must honor the Configure-Tools-only access model, tighten bridge error surfacing, and ensure architectural documentation remains synchronized.

---

## Summary

Plan 016.1 collapses the dual authorization model (workspace setting + Configure Tools toggles), removes the misleading status bar, and prioritizes diagnosing the hidden errors behind ingest/retrieve timeouts. These changes directly support Epic 0.3.0.3 by restoring trust in tool availability and ensuring bridge operations surface actionable failures. Architectural documentation and diagram have been updated to reflect the Configure Tools-only gate and Output-channel transparency surface.

---

## Critical Findings (must be addressed during implementation)

1. **Single Source of Truth for Enablement**
   - Commands (`retrieveForAgent`, `ingestForAgent`) must consult the same Configure Tools enablement state as the language model tools. If tools are disabled, commands must fail fast with a clear error (e.g., `AGENT_ACCESS_DISABLED`) and log the attempt.
   - No code path should reintroduce `cogneeMemory.agentAccess.enabled` or any shadow configuration.

2. **Bridge Error Surfacing + Minimal Taxonomy**
   - Diagnostic logging must emit structured error payloads (exception type, message, stack) and ensure `CogneeClient` relays them to Output channel. Even though Epic 0.2.3.1 will deliver the full taxonomy, this hotfix must at least categorize the newly surfaced failures (e.g., `LLM_API_ERROR`, `COGNEE_HASHING_ERROR`, `PYTHON_ENV_ERROR`) so user-facing guidance is actionable.

---

## Medium Findings / Integration Requirements

1. **Documentation Alignment** – README, AGENT_INTEGRATION, CHANGELOG, and any onboarding copy must describe Configure Tools as the sole opt-in surface. References to the removed setting/status bar should be scrubbed or clearly labeled as pre-v0.3.2 behavior.
2. **Testing Scope** – Add a repo-wide sweep (lint/test) that fails if `cogneeMemory.agentAccess.enabled` appears again. Integration tests should verify tool enablement changes propagate immediately to commands (e.g., disable tool ➜ command invocation returns `AGENT_ACCESS_DISABLED`).
3. **Transparency Expectations** – Since the status bar is gone, ensure Output channel entries remain verbose (timestamp, tool, arguments digest, result, error codes). QA documentation should point users to Configure Tools + Output logs as the authoritative state indicators.
4. **Timeout Diagnostics** – The bridge logging work must differentiate between genuine long-running operations and hangs. Capturing timestamps for each phase (ontology load, LLM call, Cognee add/search) will aid future root-cause analysis.

---

## Open Questions for Planner/Implementer

1. Should we persist the last-known tool enablement state in `Memento` so commands invoked before VS Code propagates events can still gate correctly?
2. Do we want to emit telemetry artifacts (e.g., JSON log in `.cognee/agent_audit.log`) for bridge errors as part of this hotfix, or leave that for Plan 017+?
3. Are there any downstream docs (e.g., QA playbooks, troubleshooting guides) that still instruct users to toggle `agentAccess.enabled` which need updates alongside README/AGENT_INTEGRATION?

---

## Actions Taken

- Updated `system-architecture.md` (Change Log entry 2025-11-19 18:05) to document the Configure Tools-only access model, removal of the status bar, and heightened bridge diagnostic expectations.
- Updated `system-architecture.mmd` diagram to remove the status bar node and highlight Output-channel diagnostics as the transparency surface.

Implementation should proceed once the above findings are incorporated into the detailed task tracking (Milestones 1–3 of Plan 016.1).
