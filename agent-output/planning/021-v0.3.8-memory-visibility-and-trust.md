# Plan 021: Memory Visibility, Validation & Onboarding (v0.3.8)

**Plan ID**: 021
**Target Release**: v0.3.8
**Epics**: 0.3.8.1, 0.3.8.2, 0.3.8.3, 0.3.8.4
**Status**: Proposed
**Owner**: Planner Agent

## Changelog

| Date | Change | Rationale |
|------|--------|-----------|
| 2025-11-23 | Initial Draft | Consolidates Epics 0.3.8.1 (Validation), 0.3.8.2 (Brand), 0.3.8.3 (Zero-Hallucination), and 0.3.8.4 (Python Setup) into a single release plan per user direction. |
| 2025-11-23 | Architecture Revision | Updated Milestone 2 to include root-cause mitigation for hallucinations. Updated Milestone 4 to coordinate refresh with BackgroundOperationManager. Expanded Milestone 1 to cover documentation. |

---

## Value Statement and Business Objective

**As a developer using RecallFlow,**
**I want to trust the system implicitly through transparent validation tools, consistent branding, reliable zero-hallucination retrieval, and friction-free setup,**
**So that I can rely on the memory graph for critical agent workflows without constantly double-checking results or troubleshooting environment issues.**

---

## Objective

Deliver Release v0.3.8, a "Trust & Onboarding" release that addresses critical quality gaps:
1.  **Trust**: Eliminate "Cognee" brand confusion, prevent retrieval hallucinations, and provide tools to validate stored memory integrity.
2.  **Onboarding**: Automate the Python environment setup to reduce drop-off rates.

## Assumptions & Constraints

*   **Internal IDs**: All internal command IDs, settings, and configuration keys MUST remain `cognee.*` to preserve backward compatibility. Only user-facing strings change to "RecallFlow".
*   **Python Version**: We assume the user has a valid Python 3.10+ interpreter available on their system (or we guide them to install it).
*   **RecallFlow SDK**: We rely on `cognee==0.4.0` (or compatible) as pinned in `requirements.txt`.
*   **VS Code Version**: Target engine `^1.85.0`.

---

## Plan

### Milestone 1: Brand Consistency Audit (Epic 0.3.8.2)

**Objective**: Eliminate "Cognee" from all user-facing surfaces.

**Tasks**:
1.  **Marketplace Metadata**:
    *   Update `package.json`: `displayName` -> "RecallFlow Chat Memory", `description` -> "Automatic memory for GitHub Copilot chat using RecallFlow...".
    *   Update `README.md`: Replace "Cognee" with "RecallFlow" in titles, intros, and feature descriptions. Keep `cognee.*` references only in code blocks/config sections.
2.  **Command Palette**:
    *   Update `package.json` `contributes.commands`: Change `title` fields to start with "RecallFlow:" (e.g., "RecallFlow: Capture to Memory").
    *   **Constraint**: Do NOT change `command` IDs (e.g., `cognee.captureMessage`).
3.  **UI Strings**:
    *   Audit `src/**/*.ts` for string literals containing "Cognee".
    *   Update Chat Participant display name/description.
    *   Update Notification titles/messages.
    *   Update Output Channel name to "RecallFlow".
    *   Update "Configure Tools" tool descriptions.
4.  **Documentation**:
    *   Update `AGENT_INTEGRATION.md` to reflect RecallFlow branding.
    *   Update `system-architecture.md` diagram labels (post-implementation).
    *   Ensure `package.json` tool metadata (titles/descriptions) matches the new brand.

**Verification**:
*   Search codebase for "Cognee" (case-insensitive). Remaining matches should only be in:
    *   Internal IDs/Variables.
    *   URLs (if repo name unchanged).
    *   Historical changelogs.

---

### Milestone 2: Zero-Hallucination Retrieval (Epic 0.3.8.3)

**Objective**: Ensure the system returns "No results" instead of low-confidence/fabricated matches, addressing root causes in the bridge.

**Tasks**:
1.  **Root Cause Analysis & Mitigation**:
    *   Instrument `retrieve.py` to log which retrieval branch (vector vs graph vs LLM augmentation) produces the result.
    *   **Disable Hallucination Paths**: Identify and disable any fallback logic that allows the LLM to generate answers not grounded in retrieved nodes.
    *   Implement **Exact-Match Fallback** (optional): If semantic search fails, attempt exact keyword matching before giving up.
2.  **Bridge Retrieval Logic (`retrieve.py`)**:
    *   Review `cognee.search` integration.
    *   Ensure `relevance_score` is correctly propagated.
    *   If `cognee` returns results with 0.0 score (or below threshold), explicitly filter them out or flag them as `irrelevant`.
3.  **Provider Filtering (`CogneeContextProvider.ts`)**:
    *   In `retrieveForAgent` and `retrieve` methods, inspect the returned results.
    *   **Strict Filter**: If `score <= 0.01` (configurable threshold), discard the result.
    *   **Empty State**: If all results are filtered, return an explicit "No relevant context found" response to the agent/user.
4.  **Transparency**:
    *   Log filtered results to Output Channel (e.g., "Filtered 3 results with score 0.00").

**Verification**:
*   Run retrieval with a query known to have no matches.
*   Verify Agent receives empty/no-context response, not a hallucination.
*   Verify Output Channel shows filtering activity.
*   **Regression Test**: Verify that disabling the hallucination path does not break valid retrieval.

---

### Milestone 3: Memory Validation & Visibility (Epic 0.3.8.1)

**Objective**: Provide tools for users to inspect and verify stored memories.

**Tasks**:
1.  **Validation Command**:
    *   Create command `RecallFlow: Validate Memories` (`cognee.validateMemories`).
    *   Implement `validate_memories.py` in bridge:
        *   Checks connection to graph.
        *   Checks integrity of `ontology.ttl`.
        *   Performs a smoke-test retrieval.
        *   **Agent Structure Check**: Scans recent `DecisionRecord` or `Summary` nodes to ensure they have populated metadata fields (topic, status, rationale) matching the optimized schema.
    *   TS: Run script, display results in Output Channel + Notification (Pass/Fail).
2.  **Memory List View**:
    *   Create command `RecallFlow: List Memories` (`cognee.listMemories`).
    *   Implement `list_memories.py` in bridge: Returns JSON list of recent memories (Topic, Date, Status).
    *   TS: Display in `vscode.window.createQuickPick` or a simple Webview.
    *   Allow clicking a memory to view full content (in output channel or virtual document).

**Verification**:
*   Run "Validate Memories" on a healthy workspace -> Success.
*   Run on a corrupted workspace (e.g., missing ontology) -> Failure with actionable error.
*   Ingest an agent summary, run validation -> Confirms structure is correct.

---

### Milestone 4: Simplified Python Setup (Epic 0.3.8.4)

**Objective**: Automate `.venv` creation and dependency management.

**Tasks**:
1.  **RecallFlowSetupService (TS)**:
    *   Implement service to manage `.cognee/bridge-env.json`.
    *   Implement `initializeWorkspace()`:
        *   Check for existing `.venv`.
        *   If missing, offer to create (Managed Mode).
        *   If present, ask to use or ignore (External Mode).
2.  **Environment Creation**:
    *   Implement logic to run `python -m venv .venv` in workspace root.
    *   Implement logic to run `pip install -r extension/bridge/requirements.txt`.
3.  **Verification Script**:
    *   Create `extension/bridge/verify_environment.py`:
        *   Imports `cognee`, `rdflib`, `dotenv`.
        *   Checks `ontology.ttl` existence.
        *   Returns JSON `{ status: "ok" | "error", details: ... }`.
4.  **Refresh Command**:
    *   Implement `RecallFlow: Refresh Bridge Dependencies` (`cognee.refreshDependencies`).
    *   **Coordination**:
        *   Pause `BackgroundOperationManager` queue intake.
        *   Drain or cancel running `cognify` jobs (write status to ledger).
        *   Show "Refreshing dependencies..." toast.
    *   Re-runs install/verification logic.
    *   Updates `.cognee/bridge-version.json` with hashes.
    *   **Resume**:
        *   Resume `BackgroundOperationManager`.
        *   Emit success toast ("Dependencies refreshed").

5.  **Walkthrough**:
    *   Add `contributes.walkthroughs` to `package.json`.
    *   Steps: "Setup Python", "Configure API Key", "Try Capture", "Try Retrieval".
    *   Trigger on first install or successful setup.

**Verification**:
*   Delete `.venv`. Run "Initialize Workspace". Verify `.venv` created and working.
*   Corrupt `.venv` (delete site-packages). Run "Refresh Dependencies". Verify restored.
*   **Concurrency Test**: Start a long-running capture, then immediately trigger "Refresh Dependencies". Verify capture is handled gracefully (cancelled/paused) and does not crash the refresh.

---

### Milestone 5: Release v0.3.8

**Objective**: Package and release.

**Tasks**:
1.  Update `package.json` version to `0.3.8`.
2.  Update `CHANGELOG.md` with all changes.
3.  Run `npm run verify:vsix` (if exists) or manual smoke test.
4.  Commit and Tag `v0.3.8`.

**Acceptance**:
*   VSIX builds successfully.
*   All P0 Epics (Brand, Hallucination, Validation, Setup) are delivered.

---

## Risks

*   **Python Path Issues**: Automating Python setup across OSs (Windows vs Linux paths) is tricky. *Mitigation*: Use VS Code's `python.interpreterPath` API if possible, or standard cross-platform path handling.
*   **Ranking Regression**: Filtering 0.00 scores might hide "weak but useful" results. *Mitigation*: Log filtered results to ensure we aren't being too aggressive.
