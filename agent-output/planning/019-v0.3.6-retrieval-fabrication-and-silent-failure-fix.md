# Plan 019: v0.3.6 Retrieval Fabrication and Silent Failure Fix

## Plan Header
- **Plan ID**: 019
- **Target Release**: v0.3.6
- **Epic Alignment**: Epic 0.3.6.1 (Background Reliability & RecallFlow Rebrand)
- **Status**: In Progress
- **Changelog**:
  - 2025-11-22: Updated Epic Alignment to 0.3.6.1 and Status to In Progress to match roadmap.
  - 2025-11-22: Created plan based on analysis `019-v0.3.5-retrieval-fabrication-and-silent-failure-analysis.md`. Addresses retrieval fabrication, silent storage failures, observability gaps, and rebranding requirements. Updated to target v0.3.6 as v0.3.5 is current.

## Value Statement and Business Objective
As a developer using RecallFlow (formerly Cognee), I want the system to accurately report when it cannot find relevant information and to reliably notify me if background processing fails, so that I can trust the tool's output and take corrective action when storage operations fail. Additionally, I want clear visibility into operation timing and a consistent brand experience.

## Objective
Implement critical bug fixes and UX enhancements for v0.3.6:
1.  **Fix Retrieval Fabrication**: Eliminate hallucinations by filtering out unscored generative results.
2.  **Fix Silent Storage Failure**: Ensure users are notified when background ingestion crashes.
3.  **Close Observability Gap**: Capture background process logs (`stdout`/`stderr`) to a file for troubleshooting.
4.  **Proactive Prevention**: Implement safeguards against common crash causes (payload limits, zombies).
5.  **UX Enhancement**: Add timestamps to the background status list.
6.  **Rebranding**: Rename user-facing "Cognee" strings to "RecallFlow".

## Assumptions
- The `BackgroundOperationManager` singleton is the central point for managing async ingestion.
- `ingest.py` and `retrieve.py` are the only entry points for their respective operations.
- The "Cognee" brand is only to be replaced in user-facing strings (UI, commands, logs), NOT in internal code symbols, configuration keys, or file paths (to preserve backward compatibility).

## Milestones

### Milestone 1: Fix Retrieval Fabrication (Scoring)
**Objective**: Prevent the system from presenting LLM hallucinations as high-confidence memories.
**Tasks**:
1.  Modify `extension/bridge/retrieve.py`:
    - Change the default `semantic_score` from `0.7` to `0.0` when the search result lacks a score (indicating a generative `GRAPH_COMPLETION` result).

### Milestone 2: Fix Silent Storage Failure (Visibility & Logging)
**Objective**: Ensure background crashes are detected, logged, and notified.
**Tasks**:
1.  Modify `extension/src/background/BackgroundOperationManager.ts`:
    - Update `spawnCognifyProcess` to redirect `stdout` and `stderr` to a persistent log file (e.g., `.cognee/logs/ingest.log`) instead of `ignore`.
    - Implement log rotation (append-only, clear on startup, or max size).
    - Update `processStatusStub` to treat a missing stub as a **failure** (call `failOperation` with "Process crashed or was killed") instead of `unknown`.
    - **Update Failure Notification**: Add a "View Logs" button to the failure toast that opens `.cognee/logs/ingest.log`.
    - **Update Output Logging**: Log the log-file path alongside the `operationId` in the Output channel (e.g., `[BACKGROUND] Operation <id> failed. See logs at <path>`).
2.  Modify `extension/bridge/ingest.py`:
    - Add signal handlers for `SIGTERM` and `SIGINT` to write a "Process Terminated" status stub.
    - Wrap execution in a global `try...finally` block to ensure status stubs are written even on unexpected crashes.

### Milestone 3: Proactive Prevention Strategy
**Objective**: Reduce the likelihood of crashes due to resource exhaustion or locking.
**Tasks**:
1.  Modify `extension/src/cogneeClient.ts` (or relevant ingestion entry point):
    - Enforce a character limit (e.g., 100k chars) on payloads before sending to `ingest.py`.
2.  Modify `extension/src/background/BackgroundOperationManager.ts`:
    - Ensure strict enforcement of the 2-process concurrency limit (verify existing logic).
    - Add startup logic to clean up any "zombie" lock files or stale PIDs from previous sessions.

### Milestone 4: UX Enhancements (Timestamp)
**Objective**: Improve the "View Status" experience.
**Tasks**:
1.  Modify `extension/src/extension.ts` (command `cognee.backgroundStatus`):
    - Update the QuickPick item generation to include the `startTime` in the description or detail field. Format: `${startTime} - ${elapsed} - ${digest}`.

### Milestone 5: Rebranding to "RecallFlow"
**Objective**: Rename user-facing elements to "RecallFlow".
**Tasks**:
1.  Modify `extension/package.json`:
    - Update `displayName` to "RecallFlow Chat Memory".
    - Update `description`.
    - Update command titles (e.g., "Capture to RecallFlow Memory").
    - Update command categories to "RecallFlow".
    - Update tool display names and descriptions.
    - **Update Language Model Tools**: Update `displayName`, `modelDescription`, and `userDescription` for `cognee_storeMemory` and `cognee_retrieveMemory` to use "RecallFlow" (e.g., "Store Memory in RecallFlow"). **Do not change** `name` or `toolReferenceName`.
    - Rename chat participant from `cognee-memory` to `recallflow-memory` (update `id` and `name`).
2.  Modify `extension/src/extension.ts`:
    - Update `registerChatParticipant` to use `recallflow-memory`.
    - Update Output Channel names to "RecallFlow Memory".
    - Update Toast messages and Help text to use "RecallFlow".
3.  **Update Documentation**:
    - Update `extension/AGENT_INTEGRATION.md` to refer to "RecallFlow" tools and commands.
    - Update Output channel section headers to use "RecallFlow".
4.  **Constraint Check**: Ensure `cogneeMemory.*` config keys and internal class names remain unchanged.

### Milestone 6: Update Version and Release Artifacts
**Objective**: Update project version to v0.3.6 and document changes.
**Tasks**:
1.  Update version in `extension/package.json` to `0.3.6`.
2.  Add CHANGELOG entry under v0.3.6 with:
    - Fix: Retrieval fabrication (scoring adjustment).
    - Fix: Silent storage failure detection.
    - Feature: Background process logging.
    - Feature: Rebranding to RecallFlow.
3.  Commit version changes.

## Testing Strategy
- **Unit Tests**: Verify `retrieve.py` returns 0.0 for unscored results.
- **Integration Tests**:
    - **Fabrication**: Run a retrieval query that yields no vector matches and verify it is filtered out (or has 0.0 score).
    - **Silent Failure**: Manually kill a background `ingest.py` process (`kill -9 <pid>`) and verify:
        - A failure toast appears.
        - The status command shows "Failed".
        - The log file contains the crash details (if captured) or at least the startup logs.
    - **Rebranding**: Verify the chat participant responds to `@recallflow-memory` and all UI elements show "RecallFlow".

## Validation
- **Manual Verification**:
    - Trigger an ingestion, kill the process, check for notification.
    - Check `.cognee/logs/ingest.log` exists and contains output.
    - Check VS Code UI for "RecallFlow" branding.

## Risks
- **Log File Growth**: If log rotation isn't implemented, the log file could grow large. (Mitigation: Implement simple truncation on startup).
- **Rebranding Misses**: Hardcoded strings might be missed. (Mitigation: Grep search for "Cognee" in `src/` and `package.json`).
