# Process Improvement: VS Code Versioning Constraint Documentation

**Date**: 2025-11-17  
**Source**: Retrospective 013.1 (Fix Ingestion Timeout and Add Metrics)  
**Improvement Type**: Documentation, Quality Gate Enhancement  
**Status**: COMPLETE

## Summary

Plan 013.1 deployment revealed that VS Code Marketplace requires exactly 3-part semantic versioning (X.Y.Z), rejecting 4-part versions (X.Y.Z.W) common in NPM ecosystem. This constraint was not documented in planning guidelines, architecture, or release checklist, resulting in mid-deployment version adjustment (0.2.2.1 → 0.2.3) requiring git commit amendment and force-push.

This process improvement documents the constraint across planning, architecture, and deployment workflows to prevent recurrence.

## Problem Statement

**What happened**: Plan 013.1 targeted version 0.2.2.1 following NPM conventions for incremental patches. During DevOps Phase 1 (pre-release verification), `vsce package` rejected the version with error "Invalid extension version: 0.2.2.1". DevOps agent independently adjusted to 0.2.3, requiring updates to package.json, CHANGELOG.md, deployment document, git commit message, and git tag.

**Why it's a problem**:
- Version adjustments during deployment add 10-15 minutes to release cycle
- Git history manipulation (commit amend, force-push) introduces risk
- Semantic versioning choice (patch vs minor bump) should align with roadmap strategy, not be decided during deployment
- Constraint is platform-specific (VS Code), not obvious to planners familiar with NPM ecosystem

**Impact**: Low severity (DevOps caught issue before deployment, no production impact), but preventable workflow friction.

## Root Cause Analysis

1. **Documentation Gap**: VS Code versioning constraint not documented in:
   - `agent-output/architecture/system-architecture.md` (no deployment constraints section)
   - `.github/agents/planner.agent.md` (no platform constraints in version management section)
   - `extension/RELEASE_CHECKLIST.md` (no version format pre-flight check)

2. **Late Detection**: Version format validated during packaging (`vsce package`) rather than during planning or critic review

3. **Missing Quality Gate**: Critic agent instructions did not include version format validation for VS Code extensions

## Implemented Changes

### 1. Planner Agent Instructions (`.github/agents/planner.agent.md`)

**Location**: "Version Management and Release Tracking" section

**Change**: Added "Platform Constraints" subsection before project-specific guidance:

```markdown
**Platform Constraints**:

**VS Code Extensions**:
- **CRITICAL**: VS Code Marketplace requires **exactly 3-part semantic versioning** (X.Y.Z format)
- **DO NOT use 4-part versions** like 0.2.2.1 - they will be rejected during packaging with "Invalid extension version" error
- Examples: ✅ 0.2.3, 1.0.0, 2.1.5 | ❌ 0.2.2.1, 1.0.0.0
- If you need to increment beyond released version, use next patch/minor/major: 0.2.2 → 0.2.3 (patch), 0.2.2 → 0.3.0 (minor)
```

**Rationale**: Shift-left version validation to planning phase. Planner now aware of constraint when defining version management milestone.

**Validation**: Future plans targeting VS Code extension releases must use 3-part semver.

### 2. Critic Agent Instructions (`.github/agents/critic.agent.md`)

**Location**: "Review Method" section, added as step 5

**Change**: Added version format validation checkpoint:

```markdown
5. **Validate version format for platform constraints**:
   - **VS Code extensions**: If plan targets `extension/package.json`, verify version is 3-part semver (X.Y.Z) - NOT 4-part (X.Y.Z.W)
   - Flag any version like "0.2.2.1" for VS Code extensions - must be "0.2.3" or similar
   - Confirm planner acknowledged platform versioning constraint in version management milestone
```

**Rationale**: Catch version format issues during plan review (before implementation), providing second quality gate after planner.

**Validation**: Critic must flag 4-part versions during review and request planner revision.

### 3. DevOps Agent Instructions (`.github/agents/devops.agent.md`)

**Location**: "Phase 1: Pre-Release Verification" section, step 4

**Change**: Enhanced version consistency check with platform constraint validation and user confirmation protocol:

```markdown
4. **Check version consistency AND platform constraints**:
   - Run `grep -r "version" package.json pyproject.toml setup.py` (language-appropriate)
   - **VS Code extensions**: Verify version in `package.json` is 3-part semver (X.Y.Z) - NOT 4-part (X.Y.Z.W)
   - If version constraint violation detected (e.g., 0.2.2.1 for VS Code), **STOP and present options to user**:
     * "VS Code requires 3-part semver. Detected [invalid version]. Options: (a) [next patch] (b) [next minor]. Recommend [option] for [reason]. Proceed?"
     * Wait for user approval before adjusting version
   - Verify `CHANGELOG.md` has release section with correct version and date
   - Check README/documentation for version references
```

**Rationale**: Third quality gate (defense in depth). If constraint slips through planning and critique, DevOps catches it during pre-release verification. User approval ensures version choice aligns with roadmap semantic versioning strategy.

**Validation**: DevOps must present version adjustment options to user before amending commits.

### 4. Release Checklist (`extension/RELEASE_CHECKLIST.md`)

**Location**: "Pre-Release > Version Management" section

**Change**: Added version format pre-flight check as first item:

```markdown
- [ ] **CRITICAL**: Version in `package.json` uses 3-part semver (X.Y.Z) - VS Code rejects 4-part versions
  - ✅ Valid: 0.2.3, 1.0.0, 2.1.5
  - ❌ Invalid: 0.2.2.1, 1.0.0.0 (will fail with "Invalid extension version")
  - Run pre-flight check: `node -e "const v = require('./package.json').version; if(!/^\d+\.\d+\.\d+$/.test(v)) throw new Error('VS Code requires 3-part semver: ' + v)"`
```

**Rationale**: Provides manual validation script for developers/release managers. Can be run before packaging to catch format issues.

**Validation**: Script exits with error if version format invalid, preventing packaging attempt.

### 5. System Architecture Document (`agent-output/architecture/system-architecture.md`)

**Location**: New Section 11 "Deployment Platform Constraints" (prior recommendations renumbered to Section 12)

**Change**: Added comprehensive deployment constraints section:

```markdown
## 11. Deployment Platform Constraints

**VS Code Marketplace Requirements**:

- **Version Format**: Requires exactly 3-part semantic versioning (X.Y.Z)
  - Valid: 0.2.3, 1.0.0, 2.1.5
  - Invalid: 0.2.2.1, 1.0.0.0 (rejected with "Invalid extension version" error)
  - Constraint discovered during Plan 013.1 deployment (2025-11-17)
- **VSIX Packaging**: All assets (bridge scripts, ontology files, media) must be included in package
- **Extension Manifest**: `package.json` must conform to VS Code extension schema

**NPM Package Differences**:

- NPM supports 4-part semantic versioning (X.Y.Z.W) for pre-release/build metadata
- This creates a trap when developing VS Code extensions that also use NPM tooling
- Always verify version format during planning for VS Code extension releases

**Git Tagging**:

- No version format restrictions for git tags
- Recommended: Match git tag to published package version for traceability
```

**Rationale**: Centralized reference for all platform-specific constraints. Planner/critic/architect agents read this document; constraint now discoverable during planning.

**Validation**: Architect must maintain this section as new platform constraints discovered.

## Expected Outcomes

**Short-term (next 1-3 releases)**:
- No version format issues during deployment
- Planner proposes valid 3-part semver for VS Code extension plans
- Critic flags any 4-part versions during review
- DevOps pre-flight checks pass without version adjustments

**Long-term (6+ releases)**:
- Pattern established: all platform constraints documented in architecture before affecting planning
- DevOps Phase 1 verification catches unexpected constraints before they require mid-deployment adjustments
- Release cycle friction reduced; no git history manipulation required for version corrections

## Validation Criteria

**Process adherence**:
- [ ] Next VS Code extension plan (Plan 014+) uses 3-part semver in version management milestone
- [ ] Critic review for next plan validates version format explicitly
- [ ] DevOps pre-release verification for next release confirms version format before packaging

**Constraint enforcement**:
- [ ] Release checklist pre-flight script detects 4-part versions if accidentally introduced
- [ ] `vsce package` runs without version-related errors in next deployment

**Documentation quality**:
- [ ] Architecture document "Deployment Platform Constraints" section remains accurate
- [ ] New platform constraints (if discovered) added to architecture document following this pattern

## Lessons Learned

1. **Platform-specific constraints are not obvious**: Developers familiar with NPM assume 4-part semver is universal. VS Code Marketplace is more restrictive.

2. **Shift-left validation prevents friction**: Catching version format issues during planning (before implementation) is far cheaper than catching during deployment (after git commits).

3. **Defense in depth works**: Multiple quality gates (planner → critic → DevOps) prevent issues from reaching production. No single gate is sufficient.

4. **User involvement in version decisions is critical**: DevOps shouldn't unilaterally choose patch vs minor bump; roadmap strategy should inform semantic versioning.

5. **Documentation must be centralized and discoverable**: Constraints scattered across chat history or tribal knowledge won't prevent recurrence. Architecture document is single source of truth.

## Related Artifacts

- **Retrospective**: `agent-output/retrospectives/013.1-fix-ingestion-timeout-and-metrics-retrospective.md`
- **Deployment Report**: `agent-output/deployment/013.1-v0.2.2-deployment-readiness.md`
- **Updated Agent Instructions**:
  - `.github/agents/planner.agent.md` (Platform Constraints section)
  - `.github/agents/critic.agent.md` (Version format validation step)
  - `.github/agents/devops.agent.md` (Platform constraint verification protocol)
- **Updated Documentation**:
  - `extension/RELEASE_CHECKLIST.md` (Version format pre-flight check)
  - `agent-output/architecture/system-architecture.md` (Section 11: Deployment Platform Constraints)

## Follow-Up Actions

- [x] Update planner.agent.md with platform constraints guidance
- [x] Update critic.agent.md with version format validation step
- [x] Update devops.agent.md with version adjustment protocol
- [x] Update RELEASE_CHECKLIST.md with version format pre-flight check
- [x] Add "Deployment Platform Constraints" section to system-architecture.md
- [ ] Monitor next VS Code extension release (Plan 014+) to validate process improvements
- [ ] Update this document with validation results after next release

## Approval

**Process Improvement Owner**: retrospective agent  
**Approval Date**: 2025-11-17  
**Status**: COMPLETE - All documentation updates applied

---

**Version**: 1.0  
**Last Updated**: 2025-11-17  
**Next Review**: After next VS Code extension release
