#!/usr/bin/env node
/**
 * generate-commands-md.js
 * 
 * Plan 109: Generates COMMANDS.md from package.json contributes.commands
 * 
 * Usage:
 *   node scripts/generate-commands-md.js
 *   node scripts/generate-commands-md.js --check  # CI mode: verify sync
 * 
 * This ensures the command reference stays in sync with package.json.
 */

const fs = require('fs');
const path = require('path');

const ROOT = path.join(__dirname, '..');
const PACKAGE_JSON_PATH = path.join(ROOT, 'package.json');
const COMMANDS_MD_PATH = path.join(ROOT, 'COMMANDS.md');

/**
 * Extracts commands from package.json contributes.commands
 * @returns {{ command: string, title: string, category?: string, enablement?: string }[]}
 */
function extractCommands() {
    const packageJson = JSON.parse(fs.readFileSync(PACKAGE_JSON_PATH, 'utf8'));
    const commands = packageJson.contributes?.commands || [];
    return commands;
}

/**
 * Extracts keybindings from package.json contributes.keybindings
 * @returns {Map<string, { key: string, mac?: string }>}
 */
function extractKeybindings() {
    const packageJson = JSON.parse(fs.readFileSync(PACKAGE_JSON_PATH, 'utf8'));
    const keybindings = packageJson.contributes?.keybindings || [];
    const map = new Map();
    for (const kb of keybindings) {
        map.set(kb.command, { key: kb.key, mac: kb.mac });
    }
    return map;
}

/**
 * Generates the COMMANDS.md content
 * @param {Array} commands 
 * @param {Map} keybindings 
 * @returns {string}
 */
function generateMarkdown(commands, keybindings) {
    const lines = [
        '# Flowbaby Commands Reference',
        '',
        '> **Auto-generated** from `package.json`. Do not edit manually.',
        '> Run `npm run generate:commands` to regenerate.',
        '',
        '## Available Commands',
        '',
        '| Command | Title | Category | Keybinding |',
        '|---------|-------|----------|------------|',
    ];

    // Sort by category, then by command
    const sorted = [...commands].sort((a, b) => {
        const catA = a.category || '';
        const catB = b.category || '';
        if (catA !== catB) return catA.localeCompare(catB);
        return a.command.localeCompare(b.command);
    });

    for (const cmd of sorted) {
        const kb = keybindings.get(cmd.command);
        const keybindingStr = kb 
            ? (kb.mac ? `\`${kb.key}\` (Mac: \`${kb.mac}\`)` : `\`${kb.key}\``)
            : '—';
        const category = cmd.category || '—';
        
        lines.push(`| \`${cmd.command}\` | ${cmd.title} | ${category} | ${keybindingStr} |`);
    }

    lines.push('');
    lines.push('## Command Categories');
    lines.push('');

    // Group by category
    const byCategory = {};
    for (const cmd of sorted) {
        const cat = cmd.category || 'Uncategorized';
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push(cmd);
    }

    for (const [category, cmds] of Object.entries(byCategory)) {
        lines.push(`### ${category}`);
        lines.push('');
        for (const cmd of cmds) {
            const kb = keybindings.get(cmd.command);
            const keybindingNote = kb ? ` (${kb.key})` : '';
            lines.push(`- **${cmd.title}**${keybindingNote}`);
            lines.push(`  - Command ID: \`${cmd.command}\``);
            if (cmd.enablement) {
                lines.push(`  - Enablement: \`${cmd.enablement}\``);
            }
        }
        lines.push('');
    }

    lines.push('---');
    lines.push('');
    lines.push('*Generated by Plan 109 - Managed Venv Defaults + Dashboard Init*');
    lines.push('');

    return lines.join('\n');
}

/**
 * Main entry point
 */
function main() {
    const isCheckMode = process.argv.includes('--check');
    
    const commands = extractCommands();
    const keybindings = extractKeybindings();
    const content = generateMarkdown(commands, keybindings);
    
    if (isCheckMode) {
        // CI mode: verify file is in sync
        if (!fs.existsSync(COMMANDS_MD_PATH)) {
            console.error('❌ COMMANDS.md does not exist. Run: npm run generate:commands');
            process.exit(1);
        }
        
        const existing = fs.readFileSync(COMMANDS_MD_PATH, 'utf8');
        if (existing !== content) {
            console.error('❌ COMMANDS.md is out of sync with package.json.');
            console.error('Run: npm run generate:commands');
            process.exit(1);
        }
        
        console.log('✅ COMMANDS.md is in sync with package.json');
        process.exit(0);
    } else {
        // Generate mode
        fs.writeFileSync(COMMANDS_MD_PATH, content, 'utf8');
        console.log(`✅ Generated ${COMMANDS_MD_PATH}`);
        console.log(`   ${commands.length} commands documented`);
    }
}

// Allow testing by exporting functions
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { extractCommands, extractKeybindings, generateMarkdown, main };
}

// Run if executed directly
if (require.main === module) {
    main();
}
