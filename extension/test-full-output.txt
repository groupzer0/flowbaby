
> flowbaby@0.6.1 pretest
> npm run compile:tests


> flowbaby@0.6.1 compile:tests
> tsc -p tsconfig.test.json && cp src/test/run-test-agent.js out/test/


> flowbaby@0.6.1 test
> node ./out/test/runTest.js

- Resolving version...
âœ” Validated version: 1.107.0
âœ” Found existing install in /home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0
[90m[main 2025-12-16T12:37:55.869Z][0m update#setState disabled
[90m[main 2025-12-16T12:37:55.870Z][0m update#ctor - updates are disabled by the environment
ChatSessionStore: Migrating 0 chat sessions from storage service to file system
Started local extension host with pid 907693.
Loading development extension at /home/luke/Documents/Github-projects/flowbaby/extension
MCP Registry configured: https://api.mcp.github.com
Settings Sync: Account status changed from uninitialized to unavailable
[0m[0m
[0m  FlowbabySetupService.checkWorkspaceHealth (Plan 039 M3)[0m
  [32m  âœ”[0m[90m returns FRESH when .flowbaby directory does not exist[0m
Flowbaby extension activated
=== MILESTONE 2: Registering @flowbaby Chat Participant ===
âœ… @flowbaby participant registered successfully
@flowbaby chat participant registered (pending initialization)
  [32m  âœ”[0m[90m returns FRESH when .flowbaby exists but bridge-env.json is missing (Plan 040 M3)[0m
  [32m  âœ”[0m[90m returns BROKEN when migration marker exists[0m
  [32m  âœ”[0m[90m returns BROKEN when venv directory is missing[0m
  [32m  âœ”[0m[90m returns BROKEN when Python executable is missing[0m
  [32m  âœ”[0m[90m returns VALID when all components are present[0m
  [32m  âœ”[0m[90m returns FRESH when bridge-env.json is malformed (Plan 040 M3)[0m
[0m  Walkthrough Prompt Preferences[0m
  [32m  âœ”[0m[90m walkthroughPromptDismissed defaults to false when not set[0m
  [32m  âœ”[0m[90m walkthroughPromptDismissed returns true after user clicks "Don't Show Again"[0m
  [32m  âœ”[0m[90m walkthroughPromptDismissed persists across "restarts" (same globalState)[0m
  [32m  âœ”[0m[90m walkthrough prompt logic: shows when not dismissed[0m
  [32m  âœ”[0m[90m walkthrough prompt logic: does not show when dismissed[0m
  [32m  âœ”[0m[90m captureHintShown preference follows same pattern[0m
[0m  Tool Integration Test Suite[0m
[0m    Tool Registration[0m
    [32m  âœ”[0m[90m Both tools register at extension activation[0m[31m (1002ms)[0m
    [32m  âœ”[0m[90m Tool UI visibility flags are correct[0m[31m (501ms)[0m
[0m    Round-Trip Integration[0m
    [32m  âœ”[0m[90m Store summary via tool and retrieve via query returns matching results[0m
[0m    Tool Response Format[0m
    [32m  âœ”[0m[90m Retrieve tool returns both narrative and JSON payload[0m
[0m  Plan 056: Tool Registration Guard Tests[0m
[0m    Duplicate-Error Classification[0m
    [32m  âœ”[0m[90m isKnownDuplicateToolError recognizes "already registered" message[0m
    [32m  âœ”[0m[90m isKnownDuplicateToolError recognizes "Tool with name" message[0m
    [32m  âœ”[0m[90m isKnownDuplicateToolError recognizes "duplicate tool" message[0m
    [32m  âœ”[0m[90m isKnownDuplicateToolError recognizes error code[0m
    [32m  âœ”[0m[90m isKnownDuplicateToolError returns false for unknown errors[0m
    [32m  âœ”[0m[90m isKnownDuplicateToolError returns false for null/undefined[0m
    [32m  âœ”[0m[90m isKnownDuplicateParticipantError recognizes "already has implementation" message[0m
    [32m  âœ”[0m[90m isKnownDuplicateParticipantError recognizes "agent already" message[0m
    [32m  âœ”[0m[90m isKnownDuplicateParticipantError recognizes "participant already registered" message[0m
    [32m  âœ”[0m[90m isKnownDuplicateParticipantError recognizes error code[0m
    [32m  âœ”[0m[90m isKnownDuplicateParticipantError returns false for unknown errors[0m
[0m    Guard State Behavior[0m
    [32m  âœ”[0m[90m areToolsRegistered returns false initially[0m
    [32m  âœ”[0m[90m isParticipantRegistered returns false initially[0m
    [32m  âœ”[0m[90m setToolsRegistered(true) sets guard to true[0m
    [32m  âœ”[0m[90m setParticipantRegistered(true) sets guard to true[0m
    [32m  âœ”[0m[90m resetRegistrationGuards resets both guards to false[0m
[0m    Tool and Participant Guard Independence (Invariant 4.5.4)[0m
    [32m  âœ”[0m[90m Setting tool guard does not affect participant guard[0m
    [32m  âœ”[0m[90m Setting participant guard does not affect tool guard[0m
    [32m  âœ”[0m[90m Both guards can be set independently to true[0m
    [32m  âœ”[0m[90m resetRegistrationGuards resets both guards atomically[0m
[0m    Host Tool Snapshot (Diagnostics Only - Invariant 4.3)[0m
    [32m  âœ”[0m[90m createHostToolSnapshot returns correct structure for empty tools[0m
    [32m  âœ”[0m[90m createHostToolSnapshot returns correct structure for non-Flowbaby tools[0m
    [32m  âœ”[0m[90m createHostToolSnapshot identifies Flowbaby tools[0m
    [32m  âœ”[0m[90m Host snapshot does not affect guard state (diagnostics only)[0m
[0m    Evidence-Only Guard Setting (Invariants 4.2.1-4.2.4)[0m
    [32m  âœ”[0m[90m Guard should only be set by explicit setToolsRegistered call[0m
    [32m  âœ”[0m[90m Guard state is process-scoped (reset clears it)[0m
[0m  Summary Generation Workflow (Plan 014)[0m
Flowbaby extension activated
=== MILESTONE 2: Registering @flowbaby Chat Participant ===
âœ… @flowbaby participant registered successfully
@flowbaby chat participant registered (pending initialization)
Flowbaby client initialized successfully
BackgroundOperationManager initialized successfully
âœ… Flowbaby.backgroundStatus command registered
FlowbabyContextProvider initialized successfully
Failed to create Flowbaby client: TypeError: Cannot read properties of undefined (reading 'get')
	at activate (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:521:73)
	at async Context.<anonymous> (/home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js:189:9)
=== @flowbaby participant invoked ===
User query: summarize this conversation
=== PLAN 014: Handling summary generation request ===
  [32m  âœ”[0m[90m WORKFLOW: "summarize this conversation" triggers summary generation[0m
Flowbaby extension deactivated
BackgroundOperationManager shutdown complete
Flowbaby extension activated
=== MILESTONE 2: Registering @flowbaby Chat Participant ===
âœ… @flowbaby participant registered successfully
@flowbaby chat participant registered (pending initialization)
Flowbaby client initialized successfully
BackgroundOperationManager initialized successfully
âœ… Flowbaby.backgroundStatus command registered
FlowbabyContextProvider initialized successfully
Failed to create Flowbaby client: TypeError: Cannot read properties of undefined (reading 'get')
	at activate (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:521:73)
	at async Context.<anonymous> (/home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js:189:9)
=== @flowbaby participant invoked ===
User query: summarize this conversation
=== PLAN 014: Handling summary generation request ===
  [32m  âœ”[0m[90m WORKFLOW: Summary with no history shows error message[0m
Flowbaby extension deactivated
BackgroundOperationManager shutdown complete
Flowbaby extension activated
=== MILESTONE 2: Registering @flowbaby Chat Participant ===
âœ… @flowbaby participant registered successfully
@flowbaby chat participant registered (pending initialization)
An unknown error occurred. Please consult the log for more details.
  [31m  1) "before each" hook for "WORKFLOW: Custom turn count extraction from prompt"[0m
Flowbaby extension deactivated
  [31m  2) "after each" hook for "WORKFLOW: Custom turn count extraction from prompt"[0m
Flowbaby client initialized successfully
Attempted to register disposable after extension deactivation Error: Registration after deactivation
	at safePush (/home/luke/Documents/Github-projects/flowbaby/extension/out/lifecycle/registrationHelper.js:463:41)
	at registerIngestForAgentCommand (/home/luke/Documents/Github-projects/flowbaby/extension/out/commands/ingestForAgent.js:63:39)
	at activate (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:478:64)
	at async Context.<anonymous> (/home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js:189:9)
[0m  README and Template Consistency (Plan 014)[0m
BackgroundOperationManager shutdown complete
  [31m  3) "after each" hook for "WORKFLOW: Custom turn count extraction from prompt"[0m
  [32m  âœ”[0m[90m SNAPSHOT: Template produces README-documented structure[0m
  [32m  âœ”[0m[90m SNAPSHOT: Template round-trip preserves all fields[0m
  [32m  âœ”[0m[90m SNAPSHOT: Empty sections render with (none) markers[0m
  [32m  âœ”[0m[90m SNAPSHOT: Section headings match documented format exactly[0m
BackgroundOperationManager initialized successfully
âœ… Flowbaby.backgroundStatus command registered
FlowbabyContextProvider initialized successfully
Attempted to register disposable after extension deactivation Error: Registration after deactivation
	at safePush (/home/luke/Documents/Github-projects/flowbaby/extension/out/lifecycle/registrationHelper.js:463:41)
	at registerRetrieveForAgentCommand (/home/luke/Documents/Github-projects/flowbaby/extension/out/commands/retrieveForAgent.js:140:39)
	at activate (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:499:68)
	at async Context.<anonymous> (/home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js:189:9)
Attempted to register disposable after extension deactivation Error: Registration after deactivation
	at safePush (/home/luke/Documents/Github-projects/flowbaby/extension/out/lifecycle/registrationHelper.js:463:41)
	at registerLanguageModelTool (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:676:51)
	at async activate (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:501:13)
	at async Context.<anonymous> (/home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js:189:9)
Attempted to register disposable after extension deactivation Error: Registration after deactivation
	at safePush (/home/luke/Documents/Github-projects/flowbaby/extension/out/lifecycle/registrationHelper.js:463:41)
	at registerLanguageModelTool (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:676:51)
	at async activate (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:501:13)
	at async Context.<anonymous> (/home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js:189:9)
Failed to create Flowbaby client: TypeError: Cannot read properties of undefined (reading 'get')
	at activate (/home/luke/Documents/Github-projects/flowbaby/extension/out/extension.js:521:73)
	at async Context.<anonymous> (/home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js:189:9)
  [31m  4) "before each" hook for "WORKFLOW: Custom turn count extraction from prompt"[0m
  [31m  5) SNAPSHOT: Section headings match documented format exactly[0m
  [32m  âœ”[0m[90m SNAPSHOT: Metadata block format matches DATAPOINT_SCHEMA.md[0m
[92m [0m[32m 50 passing[0m[90m (2s)[0m
[31m  5 failing[0m
[0m  1) Summary Generation Workflow (Plan 014)
       "before each" hook for "WORKFLOW: Custom turn count extraction from prompt":
[0m[31m     Uncaught Error: Channel has been closed[0m[90m
  	at s (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2431)
  	at Object.appendLine (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2570)
  	at PythonBridgeDaemonManager.log (out/bridge/PythonBridgeDaemonManager.js:578:28)
  	at PythonBridgeDaemonManager.handleStderr (out/bridge/PythonBridgeDaemonManager.js:302:22)
  	at Socket.<anonymous> (out/bridge/PythonBridgeDaemonManager.js:236:18)
  	at Socket.emit (node:events:519:28)
  	at addChunk (node:internal/streams/readable:561:12)
  	at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
  	at Readable.push (node:internal/streams/readable:392:5)
  	at Pipe.onStreamRead (node:internal/stream_base_commons:189:23)
[0m
[0m  2) Summary Generation Workflow (Plan 014)
       "after each" hook for "WORKFLOW: Custom turn count extraction from prompt":
[0m[31m     Uncaught Error: Channel has been closed[0m[90m
  	at s (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2431)
  	at Object.appendLine (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2570)
  	at PythonBridgeDaemonManager.log (out/bridge/PythonBridgeDaemonManager.js:578:28)
  	at PythonBridgeDaemonManager.handleStderr (out/bridge/PythonBridgeDaemonManager.js:302:22)
  	at Socket.<anonymous> (out/bridge/PythonBridgeDaemonManager.js:236:18)
  	at Socket.emit (node:events:519:28)
  	at addChunk (node:internal/streams/readable:561:12)
  	at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
  	at Readable.push (node:internal/streams/readable:392:5)
  	at Pipe.onStreamRead (node:internal/stream_base_commons:189:23)
[0m
[0m  3) Summary Generation Workflow (Plan 014)
       "after each" hook for "WORKFLOW: Custom turn count extraction from prompt":
[0m[31m     Error: done() called multiple times in hook <Summary Generation Workflow (Plan 014) "after each" hook for "WORKFLOW: Custom turn count extraction from prompt"> of file /home/luke/Documents/Github-projects/flowbaby/extension/out/test/summaryWorkflow.integration.test.js[0m[90m
  
[0m
[0m  4) Summary Generation Workflow (Plan 014)
       "before each" hook for "WORKFLOW: Custom turn count extraction from prompt":
[0m[31m     Uncaught Error: Channel has been closed[0m[90m
  	at s (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2431)
  	at Object.appendLine (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2570)
  	at PythonBridgeDaemonManager.log (out/bridge/PythonBridgeDaemonManager.js:578:28)
  	at PythonBridgeDaemonManager.handleStderr (out/bridge/PythonBridgeDaemonManager.js:302:22)
  	at Socket.<anonymous> (out/bridge/PythonBridgeDaemonManager.js:236:18)
  	at Socket.emit (node:events:519:28)
  	at addChunk (node:internal/streams/readable:561:12)
  	at readableAddChunkPushByteMode (node:internal/streams/readable:512:3)
  	at Readable.push (node:internal/streams/readable:392:5)
  	at Pipe.onStreamRead (node:internal/stream_base_commons:189:23)
[0m
[0m  5) README and Template Consistency (Plan 014)
       SNAPSHOT: Section headings match documented format exactly:
[0m[31m     Uncaught Error: Channel has been closed[0m[90m
  	at s (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2431)
  	at Object.appendLine (file:///home/luke/Documents/Github-projects/flowbaby/extension/.vscode-test/vscode-linux-x64-1.107.0/resources/app/out/vs/workbench/api/node/extensionHostProcess.js:123:2570)
  	at PythonBridgeDaemonManager.log (out/bridge/PythonBridgeDaemonManager.js:578:28)
  	at PythonBridgeDaemonManager.handleProcessExit (out/bridge/PythonBridgeDaemonManager.js:320:14)
  	at ChildProcess.<anonymous> (out/bridge/PythonBridgeDaemonManager.js:240:18)
  	at ChildProcess.emit (node:events:519:28)
  	at maybeClose (node:internal/child_process:1101:16)
  	at Socket.<anonymous> (node:internal/child_process:456:11)
  	at Socket.emit (node:events:519:28)
  	at Pipe.<anonymous> (node:net:346:12)
[0m
Error: 5 tests failed.
	at /home/luke/Documents/Github-projects/flowbaby/extension/out/test/index.js:60:28
	at done (/home/luke/Documents/Github-projects/flowbaby/extension/node_modules/mocha/lib/mocha.js:1000:7)
[90m[main 2025-12-16T12:37:59.296Z][0m Extension host with pid 907693 exited with code: 0, signal: unknown.
Exit code:   1
Failed to run tests: TestRunFailedError: Test run failed with code 1
    at ChildProcess.onProcessClosed (/home/luke/Documents/Github-projects/flowbaby/extension/node_modules/@vscode/test-electron/out/runTest.js:110:24)
    at ChildProcess.emit (node:events:519:28)
    at ChildProcess._handle.onexit (node:internal/child_process:293:12) {
  code: 1,
  signal: undefined
}
